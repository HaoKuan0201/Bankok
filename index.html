<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›¼è°·äº”æ—¥è‡ªç”±è¡Œ</title>
    <link rel="stylesheet" href="style.css">
    <script src="originalTripData.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabaseData.js"></script>
</head>
<body>

    <header class="app-header">
        <div class="header-top">
            <div class="header-titles">
                <h1>æ›¼è°·äº”æ—¥è‡ªç”±è¡Œ</h1>
                <p class="subtitle">11/27 (å››) - 12/1 (ä¸€)</p>
            </div>
            
            <div class="header-controls">

                <div class="more-menu-container">
                    <button id="more-menu-btn" class="icon-btn" onclick="toggleMoreMenu()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="19" cy="12" r="1"></circle>
                            <circle cx="5" cy="12" r="1"></circle>
                        </svg>
                    </button>

                    <div id="more-menu-dropdown" class="more-menu-dropdown">
                        
                        <button class="icon-btn" onclick="openQRModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <path d="M3 14h7v7H3z"></path>
                            </svg>
                            TDAC QR
                        </button>

                        <button id="reload-server-data-btn" class="icon-btn reload-server-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M23 4v6h-6"></path>
                                <path d="M1 20v-6h6"></path>
                                <path d="M20.49 9A9 9 0 0 0 5.51 9"></path>
                                <path d="M3.51 15A9 9 0 0 0 18.49 15"></path>
                            </svg>
                            é‡ç½®è³‡æ–™
                        </button>
                        
                        <button id="theme-toggle-btn" class="icon-btn theme-toggle-btn">
                            <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                            åˆ‡æ›ä¸»é¡Œ
                        </button>

                        <button id="copy-data-btn" class="icon-btn copy-btn" onclick="copyAppDataToClipboard()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                            </svg>
                            è¤‡è£½æ•¸æ“š
                        </button>
                    </div>
                </div>
                
                <a href="https://www.google.com/maps/d/u/0/edit?mid=1pJlG73WanZkVkTSFvt3GLpMCDVU8heQ&ll=13.798196927110428%2C100.54907266665649&z=17" 
                    target="_blank" 
                    id="map-bookmark-btn" 
                    class="icon-btn map-bookmark-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/>
                        <line x1="16" x2="16" y1="2" y2="22"/>
                        <line x1="8" x2="8" y1="2" y2="18"/>
                    </svg>
                </a>
                
                <button id="edit-toggle-btn" class="icon-btn edit-toggle-btn" onclick="toggleEditMode()">
                    <svg id="edit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>
    
    <div id="toast-notification"></div>

    <nav class="day-nav">
        <div class="nav-container" id="nav-container">
        </div>
    </nav>

    <div id="swipe-container">
        <main id="schedule-container" class="schedule-container"></main>
    </div>
    
    <div id="edit-modal" class="edit-modal">
        <div class="modal-content">
            <h3 id="modal-title">ç·¨è¼¯è¡Œç¨‹</h3>
            <form id="event-form">
                <input type="hidden" id="event-day-index">
                <input type="hidden" id="event-index">

                <div class="form-group">
                    <label for="event-time-input">æ™‚é–“ (æ ¼å¼: HH:MM æˆ– HH:MM-HH:MM)</label>
                    <input type="text" id="event-time-input" required>
                </div>

                <div class="form-group">
                    <label for="event-location-input">åœ°é»/æ´»å‹•</label>
                    <input type="text" id="event-location-input" required>
                </div>
                
                <div class="form-group">
                    <label for="event-map-url-input">åœ°åœ–é€£çµ (å¯é¸)</label>
                    <input type="url" id="event-map-url-input">
                </div>

                <div class="form-group">
                    <label for="event-note-url-input">å‚™è¨»é€£çµ (å¯é¸ï¼Œä¾‹å¦‚é è¨‚ç¶²å€)</label>
                    <input type="url" id="event-note-url-input">
                </div>

                <div class="form-group">
                    <label for="event-transport-input">äº¤é€šæ–¹å¼ (ä¾‹å¦‚: æ­¥è¡Œ, BTS, Bolt)</label>
                    <input type="text" id="event-transport-input" required>
                </div>

                <div class="form-group">
                    <label for="event-estimated-cost-input">é ä¼°èŠ±è²» (æ³°éŠ–)</label>
                    <input type="number" id="event-estimated-cost-input" value="0" min="0">
                </div>
                
                <div class="form-group">
                    <label for="event-notes-input">å‚™è¨» (å¯é¸)</label>
                    <textarea id="event-notes-input" rows="3"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button type="submit" class="save-btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="qr-modal" class="edit-modal">
        <div class="modal-content qr-modal-content">
            <h3>TDAC QR Code</h3>
            
            <div class="qr-btn-group">
                <button class="qr-person-btn active" onclick="switchQR('æˆ‘', this)">æˆ‘</button>
                <button class="qr-person-btn" onclick="switchQR('åª½', this)">åª½</button>
                <button class="qr-person-btn" onclick="switchQR('å¦¹', this)">å¦¹</button>
            </div>

            <div class="qr-image-container">
                <img id="qr-image-display" src="tdac_æˆ‘.png" alt="" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2NjYyIgc3Ryb2tlLXdpZHRoPSIxIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxyZWN0IHg9IjMiIHk9IjMiIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgcng9IjIiIHJ5PSIyIi8+PHBhdGggZD0iTTEyIDh2OCIvPjxwYXRoIGQ9Ik04IDEybDggMCIvPjwvc3ZnPg=='">
            </div>

            <div class="button-group" style="justify-content: center;">
                <button type="button" class="cancel-btn" onclick="closeQRModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

<script>

    // --- æ•¸æ“šèˆ‡ç‹€æ…‹ç®¡ç† ---
    const STORAGE_KEY = 'bangkokTripData';
    const CHECK_KEY_SUFFIX = '_done';
    const COST_KEY_SUFFIX = '_cost';

    let appData = {};
    let currentDayIndex = 0;
    let isEditMode = false;
    // ä¿®æ­£ Bug 2: é™åˆ¶æ»‘å‹•åµæ¸¬ç¯„åœ
    let isSwiping = false; // æ–°å¢æ¨™èªŒï¼Œé¿å…å¤šé‡æ»‘å‹•è§¸ç™¼
    let mouseStartX = 0;
    let touchStartX = 0;
    let touchEndX = 0;
    const minSwipeDistance = 50;

    function loadData() {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            try {
                const parsedData = JSON.parse(storedData);
                if (parsedData.days && parsedData.days.length > 0) {
                    return parsedData;
                }
            } catch (e) {
                console.error("Error parsing stored data, falling back to original data.", e);
            }
        }
        return originalTripData;
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }

    function getSortableTime(timeStr) {
        if (!timeStr || typeof timeStr !== 'string') return '99:99'; 
        const parts = timeStr.split('-');
        return parts[0].trim();
    }

    function sortEventsByTime(events) {
        events.sort((a, b) => {
            const timeA = getSortableTime(a.time);
            const timeB = getSortableTime(b.time);

            if (timeA < timeB) {
                return -1;
            }
            if (timeA > timeB) {
                return 1;
            }
            return 0;
        });
    }

    // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½ ---
    document.addEventListener('DOMContentLoaded', () => {
        appData = loadData();
        initApp();
        document.getElementById('event-form').addEventListener('submit', handleSaveEvent);
        
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('more-menu-dropdown');
            const btn = document.getElementById('more-menu-btn');
            // ä¿®æ­£ Bug 1 ç›¸é—œï¼šç¢ºä¿é»æ“Šèœå–®å…§éƒ¨æŒ‰éˆ•å¾Œï¼Œèœå–®ä¹Ÿèƒ½é—œé–‰ (openQRModal æœƒè² è²¬é—œé–‰)
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('show');
            }
        });

        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        if(themeToggleBtn) {
            themeToggleBtn.addEventListener('click', () => {
                const current = document.body.getAttribute('data-theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                
                document.body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
                
                document.getElementById('more-menu-dropdown').classList.remove('show');
            });
        }
        
        const reloadBtn = document.getElementById('reload-server-data-btn');
        if(reloadBtn) {
            reloadBtn.addEventListener('click', handleReloadServerData);
        }

        const dayNav = document.querySelector('.day-nav');
        if(dayNav) {
            dayNav.addEventListener('click', (e) => {
                if (e.target === dayNav || e.target.closest('.nav-container')) {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
            });
        }
        
        initSwipeListeners();
        initScrollListener();
        initTheme();
    });

    function initApp() {
        determineInitialDay();
        renderNavigation();
        renderDay(currentDayIndex);
        updateEditButtonUI();
    }
    
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
    }

    function initSwipeListeners() {
        const swipeContainer = document.getElementById('swipe-container');
        if (!swipeContainer) return;
        
        swipeContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
        swipeContainer.addEventListener('touchend', handleTouchEnd, { passive: true });

        // ä¿®æ­£ Bug 2: å°‡ mouse events ç›£è½é™åˆ¶åœ¨ #swipe-container å…§
        swipeContainer.addEventListener('mousedown', handleMouseStart);
        swipeContainer.addEventListener('mouseup', handleMouseSwipe);

        // ç§»é™¤å° document.body çš„ mouseup/mousedown ç›£è½
        // document.body.addEventListener('mousedown', (e) => { mouseStartX = e.screenX; });
        // document.body.addEventListener('mouseup', handleMouseSwipe);
    }
    
    function initScrollListener() {
        let lastScrollY = window.scrollY;
        const dayNav = document.querySelector('.day-nav');

        window.addEventListener('scroll', () => {
            const currentScrollY = window.scrollY;
            
            if (currentScrollY > lastScrollY && currentScrollY > 150) {
                dayNav.classList.remove('show');
                dayNav.classList.add('hide');
            } else if (currentScrollY < lastScrollY) {
                dayNav.classList.remove('hide');
                dayNav.classList.add('show');
            }
            
            lastScrollY = currentScrollY;
        });
    }

    // --- UI/æ¸²æŸ“é‚è¼¯ ---
    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.add('visible');
        // ç¢ºä¿ Toast é¡¯ç¤ºæ™‚å¯ä»¥æ¥æ”¶ pointer event (é›–ç„¶é€šå¸¸æ˜¯ç‚ºäº†é˜²æ­¢é»æ“Šç©¿é€)
        toast.style.pointerEvents = 'auto'; 
        
        clearTimeout(window.toastTimeout);
        window.toastTimeout = setTimeout(() => {
            toast.classList.remove('visible');
            
            // ã€â­ é—œéµä¿®æ­£ â­ã€‘
            // å»¶é²ä¸€é»é»æ™‚é–“ï¼ˆé…åˆ CSS transition 0.3sï¼‰ï¼Œç¢ºä¿ Toast å®Œå…¨éš±è—å¾Œæ‰ç¦ç”¨é»æ“Šäº‹ä»¶
            setTimeout(() => {
                toast.style.pointerEvents = 'none';
            }, 300); 

        }, 3000);
    }

    function determineInitialDay() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const todayStr = `${year}-${month}-${day}`;

        const foundIndex = appData.days.findIndex(d => d.fullDate === todayStr);
        
        if (foundIndex !== -1) {
            currentDayIndex = foundIndex;
        } else {
            currentDayIndex = 0;
        }
    }

    function renderNavigation() {
        const navContainer = document.getElementById('nav-container');
        navContainer.innerHTML = '';

        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        appData.days.forEach((dayData, index) => {
            const btn = document.createElement('button');
            btn.className = `nav-btn ${index === currentDayIndex ? 'active' : ''}`;

            const dateObj = new Date(dayData.fullDate);
            const month = dateObj.getMonth() + 1;
            const date = dateObj.getDate();
            const weekday = weekdays[dateObj.getDay()];

            btn.textContent = `${dayData.day} (${month}/${date} ${weekday})`;
            
            btn.onclick = () => {
                currentDayIndex = index;
                updateNavState();
                renderDay(index);
            };
            navContainer.appendChild(btn);
        });
        
        setTimeout(updateNavState, 100);
    }

    function updateNavState() {
        const btns = document.querySelectorAll('.nav-btn');
        btns.forEach((btn, index) => {
            if (index === currentDayIndex) {
                btn.classList.add('active');
                btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            } else {
                btn.classList.remove('active');
            }
        });
    }
    
    function renderDay(dayIndex) {
        const container = document.getElementById('schedule-container');
        const dayData = appData.days[dayIndex];
        
        container.innerHTML = '';

        const themeHeader = document.createElement('div');
        themeHeader.style.textAlign = 'center';
        themeHeader.innerHTML = `<h2 class="day-theme">${dayData.theme}</h2>`;
        container.appendChild(themeHeader);

        const timeline = document.createElement('div');
        timeline.className = 'timeline';

        let dailyTotal = 0;

        dayData.events.forEach((event, eventIndex) => {
            const storageKeyPrefix = `trip_d${dayIndex}_e${eventIndex}`;
            const isCompleted = localStorage.getItem(`${storageKeyPrefix}${CHECK_KEY_SUFFIX}`) === 'true';
            const storedCost = localStorage.getItem(`${storageKeyPrefix}${COST_KEY_SUFFIX}`);
            
            const displayCost = storedCost !== null ? storedCost : '';
            if (storedCost && !isNaN(parseInt(storedCost))) dailyTotal += parseInt(storedCost);

            const card = document.createElement('div');
            card.className = `event-card ${isCompleted ? 'completed' : ''}`;
            card.id = `card-${dayIndex}-${eventIndex}`;

            let transportIcon = 'ğŸš¶';
            let transportClass = 'trans-walk';
            const t = event.transport ? event.transport.toLowerCase() : '';
            
            if (t.includes('bts') || t.includes('mrt')) {
                transportIcon = 'ğŸš†';
                transportClass = 'trans-bts';
            } else if (t.includes('èˆ¹') || t.includes('æ¸¡è¼ª') || t.includes('ferry')) {
                transportIcon = 'â›´ï¸';
                transportClass = 'trans-boat';
            } else if (t.includes('bolt') || t.includes('åŒ…è»Š') || t.includes('å…¬è»Š') || t.includes('car')) {
                transportIcon = 'ğŸš—';
                transportClass = 'trans-car';
            }
            else if (t.includes('é£›æ©Ÿ')) {
                transportIcon = 'âœˆï¸';
                transportClass = 'trans-bts';
            }

            const formattedNotes = formatNotes(event.notes);
            
            let headerContent = '';
            if (isEditMode) {
                headerContent = `
                    <div class="edit-controls">
                        <button onclick="startEditEvent(${dayIndex}, ${eventIndex})" class="edit-icon">
                            âœï¸
                        </button>
                        <button onclick="deleteEvent(${dayIndex}, ${eventIndex})" class="delete-icon">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                `;
            } 

            const mapIconHTML = event.mapURL ? `
                <a href="${event.mapURL}" target="_blank" class="map-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                    </svg>
                </a>
            ` : '';

            const noteIconHTML = event.noteURL ? `
                <a href="${event.noteURL}" target="_blank" class="note-icon">
                    ğŸš€
                </a>
            ` : '';

            const notesHTML = event.notes ? `
                <div class="notes-container" id="notes-container-${dayIndex}-${eventIndex}">
                    <div class="event-notes collapsed" id="event-notes-${dayIndex}-${eventIndex}">
                        ${formattedNotes}
                    </div>
                    <button class="toggle-notes-btn" onclick="toggleNotes(${dayIndex}, ${eventIndex}, this)">
                        å±•é–‹å‚™è¨» ğŸ”½
                    </button>
                </div>
            ` : '';
            
            card.innerHTML = `
                <div class="event-header">
                    <span class="event-time">${event.time}</span>
                    ${headerContent}
                </div>
                
                <div class="event-location-group">
                    <div class="event-location">${event.location}</div>
                    ${mapIconHTML}
                    ${noteIconHTML}
                </div>
                
                <div class="event-details">
                    <span class="badge ${transportClass}">${transportIcon} ${event.transport}</span>
                    <div class="cost-section" onclick="enableCostEdit(${dayIndex}, ${eventIndex}, this)">
                        <span id="cost-display-${dayIndex}-${eventIndex}">
                            ${storedCost ? `å¯¦æ”¯: à¸¿${storedCost}` : `é ä¼°: à¸¿${event.cost}`}
                        </span>
                    </div>
                </div>
                
                ${notesHTML}
            `;

            timeline.appendChild(card);
        });

        container.appendChild(timeline);
        
        if (isEditMode) {
            const addBtn = document.createElement('button');
            addBtn.className = 'add-event-btn';
            addBtn.textContent = '+ æ–°å¢è¡Œç¨‹';
            addBtn.onclick = () => startAddEvent(dayIndex);
            container.appendChild(addBtn);
        }

        const summary = document.createElement('div');
        summary.className = 'daily-summary';
        summary.innerHTML = `
            <div class="total-label">æœ¬æ—¥å¯¦éš›ç¸½èŠ±è²»</div>
            <div class="total-amount">à¸¿${dailyTotal}</div>
            <button class="reset-btn" onclick="resetDailyCosts(${dayIndex})">é‡ç½®æœ¬æ—¥èŠ±è²»</button>
        `;
        container.appendChild(summary);
    }
    
    function updateEditButtonUI() {
        const btn = document.getElementById('edit-toggle-btn');
        const iconElement = document.getElementById('edit-icon');

        if (isEditMode) {
            btn.classList.add('active');
            btn.title = 'çµæŸç·¨è¼¯æ¨¡å¼';
            iconElement.innerHTML = `<path d="M5 12l5 5l8-8"/>`;
        } else {
            btn.classList.remove('active');
            btn.title = 'åˆ‡æ›ç·¨è¼¯æ¨¡å¼';
            iconElement.innerHTML = `<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>`;
        }
    }
    
    function updateThemeIcon(theme) {
        const themeIcon = document.getElementById('theme-icon');
        if (theme === 'dark') {
            themeIcon.innerHTML = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`;
        } else {
            themeIcon.innerHTML = `
                <circle cx="12" cy="12" r="5"/>
                <line x1="12" y1="1" x2="12" y2="3"/>
                <line x1="12" y1="21" x2="12" y2="23"/>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                <line x1="1" y1="12" x2="3" y2="12"/>
                <line x1="21" y1="12" x2="23" y2="12"/>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            `;
        }
    }

    // --- ç·¨è¼¯èˆ‡æ“ä½œé‚è¼¯ ---
    
    window.toggleEditMode = function() {
        isEditMode = !isEditMode;
        updateEditButtonUI();
        renderDay(currentDayIndex);
    }

    function handleSaveEvent(e) {
        e.preventDefault();
        
        const dayIndex = parseInt(document.getElementById('event-day-index').value);
        const eventIndex = parseInt(document.getElementById('event-index').value);

        const newEvent = {
            time: document.getElementById('event-time-input').value,
            location: document.getElementById('event-location-input').value,
            mapURL: document.getElementById('event-map-url-input').value.trim(),
            noteURL: document.getElementById('event-note-url-input').value.trim(),
            transport: document.getElementById('event-transport-input').value,
            cost: document.getElementById('event-estimated-cost-input').value || '0',
            notes: document.getElementById('event-notes-input').value
        };

        if (eventIndex === -1) {
            appData.days[dayIndex].events.push(newEvent);
        } else {
            appData.days[dayIndex].events[eventIndex] = newEvent;
        }

        sortEventsByTime(appData.days[dayIndex].events);

        saveData();
        closeEditModal();
        renderDay(dayIndex);
    }

    window.deleteEvent = function(dayIndex, eventIndex) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ")) return;

        appData.days[dayIndex].events.splice(eventIndex, 1);
        saveData();
        
        localStorage.removeItem(`trip_d${dayIndex}_e${eventIndex}${CHECK_KEY_SUFFIX}`);
        localStorage.removeItem(`trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`);
        
        sortEventsByTime(appData.days[dayIndex].events);
        renderDay(dayIndex);
    }
    
    window.handleReloadServerData = function() {
        const userConfirmed = confirm(
            "âš ï¸ é€™æœƒæŠŠä½ ç›®å‰åœ¨ localStorage è£¡çš„æ‰€æœ‰è‡ªè¨‚è¡Œç¨‹ã€è¨˜å¸³ã€å®Œæˆç‹€æ…‹å…¨éƒ¨è¦†è“‹ï¼Œæ¢å¾©æˆæœ€ä¸€é–‹å§‹çš„åŸå§‹è¡Œç¨‹ï¼\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ"
        );

        if (!userConfirmed) return;

        appData = JSON.parse(JSON.stringify(originalTripData));

        localStorage.removeItem(STORAGE_KEY);

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (key.startsWith('trip_') || key.startsWith('bangkokTripData'))) {
                localStorage.removeItem(key);
            }
        }

        saveData();

        showToast('âœ… å·²æˆåŠŸå¾ä¼ºæœå™¨é‡æ–°è¼‰å…¥åŸå§‹è¡Œç¨‹ï¼');
        setTimeout(() => location.reload(), 1200);
    }

    // --- æ»‘å‹•é‚è¼¯ ---
    function handleTouchStart(e) {
        touchStartX = e.changedTouches[0].screenX;
        isSwiping = true;
    }

    function handleTouchEnd(e) {
        if (!isSwiping) return;
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe(touchStartX, touchEndX);
        isSwiping = false;
    }
    
    function handleMouseStart(e) {
        // ç¢ºä¿åªæœ‰æ»‘é¼ å·¦éµé»æ“Šæ‰é–‹å§‹åµæ¸¬
        if (e.button !== 0) return; 
        mouseStartX = e.screenX;
        isSwiping = true;
    }

    function handleSwipe(startX, endX) {
        const swipeDistance = startX - endX;

        if (Math.abs(swipeDistance) < minSwipeDistance) return;

        // é¿å…é‡è¤‡åŸ·è¡Œ
        if (Date.now() - (window.lastSwipeTime || 0) < 300) return; 
        window.lastSwipeTime = Date.now();

        if (swipeDistance > 0) { // å·¦æ»‘ (åˆ°ä¸‹ä¸€å¤©)
            if (currentDayIndex < appData.days.length - 1) {
                currentDayIndex++;
            }
        } else { // å³æ»‘ (åˆ°å‰ä¸€å¤©)
            if (currentDayIndex > 0) {
                currentDayIndex--;
            }
        }

        updateNavState();
        renderDay(currentDayIndex);

        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    function handleMouseSwipe(e) {
        if (!isSwiping) return;
        isSwiping = false;

        const diff = mouseStartX - e.screenX;
        if (Math.abs(diff) > 80) { // å¢åŠ é–¾å€¼ï¼Œç¢ºä¿æ˜¯æ•…æ„çš„æ»‘å‹•
            handleSwipe(mouseStartX, e.screenX);
        }
    }

    // --- è¨˜å¸³èˆ‡å‚™è¨»é‚è¼¯ ---
    window.toggleNotes = function(dayIndex, eventIndex, button) {
        const notesElement = document.getElementById(`event-notes-${dayIndex}-${eventIndex}`);
        
        if (notesElement.classList.contains('collapsed')) {
            notesElement.classList.remove('collapsed');
            button.textContent = 'æ”¶èµ·å‚™è¨» ğŸ”¼';
            notesElement.style.maxHeight = notesElement.scrollHeight + "px";
        } else {
            notesElement.classList.add('collapsed');
            button.textContent = 'å±•é–‹å‚™è¨» ğŸ”½';
            notesElement.style.maxHeight = '100px'; 
        }
    }

    function formatNotes(text) {
        if (!text) return "";

        const lines = text.trim().split('\n').map(line => line.trim()).filter(line => line.length > 0);

        let html = '<ul>';

        const applyHighlighting = (item) => {
            let itemHtml = item;

            itemHtml = itemHtml.replace(/(\([^)]+\))/g, (match) => {
                return `<span class="highlight-parentheses">${match}</span>`;
            });

            itemHtml = itemHtml.replace(/(\b\d+[\s%å€‹]*)/g, (match) => {
                return `<span class="price-info">${match}</span>`;
            });

            return itemHtml;
        };


        lines.forEach(line => {
            const separatorIndex = line.indexOf('-');

            if (separatorIndex !== -1 && (separatorIndex > 0 || separatorIndex < line.length - 1)) {

                const floorTitle = applyHighlighting(line.substring(0, separatorIndex).trim());
                const content = line.substring(separatorIndex + 1).trim();

                html += `
                    <li class="floor-section">
                        <h3 class="floor-title">âœ¨ ${floorTitle}</h3>
                        <ul class="floor-content-list">
                `;

                const contentItems = content.split(/\s*(?:ã€|,)\s*(?![^(]*\))/).map(item => item.trim()).filter(item => item.length > 0);

                contentItems.forEach(item => {
                    const itemHtml = applyHighlighting(item);
                    html += `<li>${itemHtml}</li>`;
                });

                html += `</ul></li>`;

            } else if (line.length > 0) {
                
                const lineHtml = applyHighlighting(line);

                html += `<li class="floor-section"><h3>âœ¨${lineHtml}</h3></li>`;
            }
        });

        html += '</ul>';

        return html;
    }

    window.toggleComplete = function(dayIndex, eventIndex, checkbox) {
        if (isEditMode) return;
        const card = document.getElementById(`card-${dayIndex}-${eventIndex}`);
        const key = `trip_d${dayIndex}_e${eventIndex}${CHECK_KEY_SUFFIX}`;
        
        if (checkbox.checked) {
            localStorage.setItem(key, 'true');
            card.classList.add('completed');
        } else {
            localStorage.removeItem(key);
            card.classList.remove('completed');
        }
    };

    window.enableCostEdit = function(dayIndex, eventIndex, element) {
        if (isEditMode) return;
        if (element.querySelector('input')) return;

        const displaySpan = document.getElementById(`cost-display-${dayIndex}-${eventIndex}`);
        const savedCost = localStorage.getItem(`trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`);
        const initialValue = savedCost ? savedCost : '';

        element.innerHTML = `
            <input type="number" class="cost-input" value="${initialValue}" 
            placeholder="é‡‘é¡" 
            onblur="saveCost(${dayIndex}, ${eventIndex}, this)" 
            onkeydown="if(event.key === 'Enter') this.blur()">
        `;
        
        const input = element.querySelector('input');
        input.focus();
    };

    window.saveCost = function(dayIndex, eventIndex, input) {
        const val = input.value;
        const key = `trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`;

        if (val && val.trim() !== "" && parseInt(val) >= 0) {
            localStorage.setItem(key, val);
        } else {
            localStorage.removeItem(key);
        }

        renderDay(dayIndex);
    };

    window.resetDailyCosts = function(dayIndex) {
        if(!confirm("ç¢ºå®šè¦é‡ç½®ä»Šå¤©çš„è¨˜å¸³æ•¸æ“šå—ï¼Ÿ")) return;
        
        const dayData = appData.days[dayIndex];
        dayData.events.forEach((_, eIndex) => {
            localStorage.removeItem(`trip_d${dayIndex}_e${eIndex}${COST_KEY_SUFFIX}`);
        });
        renderDay(dayIndex);
    };

    // --- Modal èˆ‡ç‰¹æ®ŠåŠŸèƒ½ ---
    window.copyAppDataToClipboard = function() {
        const dataToCopy = JSON.stringify(appData, null, 4); 
        
        const textarea = document.createElement('textarea');
        textarea.value = 'const originalTripData = ' + dataToCopy + ';';
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        
        textarea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showToast('âœ… æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            } else {
                showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
            }
        } catch (err) {
            console.error('Copy command failed:', err);
            showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
        }
        
        document.body.removeChild(textarea);
        
        document.getElementById('more-menu-dropdown').classList.remove('show');
    }

    window.toggleMoreMenu = function() {
        const dropdown = document.getElementById('more-menu-dropdown');
        dropdown.classList.toggle('show');
    }

    function openEditModal(dayIndex, eventIndex, isNew = false) {
        const modal = document.getElementById('edit-modal');
        const form = document.getElementById('event-form');
        const title = document.getElementById('modal-title');
        
        form.reset();
        
        document.getElementById('event-day-index').value = dayIndex;
        document.getElementById('event-index').value = eventIndex !== null ? eventIndex : -1;

        if (isNew) {
            title.textContent = 'æ–°å¢è¡Œç¨‹';
            document.getElementById('event-estimated-cost-input').value = '0';
        } else {
            title.textContent = 'ç·¨è¼¯è¡Œç¨‹';
            const event = appData.days[dayIndex].events[eventIndex];
            document.getElementById('event-time-input').value = event.time;
            document.getElementById('event-location-input').value = event.location;
            document.getElementById('event-map-url-input').value = event.mapURL || '';
            document.getElementById('event-note-url-input').value = event.noteURL || '';
            document.getElementById('event-transport-input').value = event.transport;
            document.getElementById('event-estimated-cost-input').value = event.cost;
            document.getElementById('event-notes-input').value = event.notes;
        }

        modal.classList.add('visible');
    }

    window.closeEditModal = function() {
        document.getElementById('edit-modal').classList.remove('visible');
    }
    
    window.startEditEvent = function(dayIndex, eventIndex) {
        openEditModal(dayIndex, eventIndex, false);
    }

    window.startAddEvent = function(dayIndex) {
        openEditModal(dayIndex, null, true);
    }

    window.openQRModal = function() {
        // ä¿®æ­£ Bug 1: é»æ“Šå¾Œç¢ºä¿èœå–®é—œé–‰
        document.getElementById('more-menu-dropdown').classList.remove('show');
        document.getElementById('qr-modal').classList.add('visible');
        
        const btns = document.querySelectorAll('.qr-person-btn');
        // ç¢ºä¿é»æ“Š 'æˆ‘' æŒ‰éˆ•ä»¥è¼‰å…¥åˆå§‹ QR ç¢¼ (é¿å…é¦–æ¬¡é–‹å•Ÿæ™‚åœ–ç‰‡éŒ¯èª¤)
        btns.forEach(b => b.textContent === 'æˆ‘' ? b.click() : null); 
    }

    window.closeQRModal = function() {
        document.getElementById('qr-modal').classList.remove('visible');
    }

    window.switchQR = function(person, btn) {
        document.querySelectorAll('.qr-person-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const img = document.getElementById('qr-image-display');
        img.src = `tdac_${person}.png`;
    }
</script>
</body>
</html>
