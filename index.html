<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›¼è°·äº”æ—¥è‡ªç”±è¡Œ</title>
    <link rel="stylesheet" href="style.css">
    <script src="originalTripData.js"></script>
</head>
<body>

    <header class="app-header">
        <div class="header-top">
            <div class="header-titles">
                <h1>æ›¼è°·äº”æ—¥è‡ªç”±è¡Œ</h1>
                <p class="subtitle">11/27 (å››) - 12/1 (ä¸€)</p>
            </div>
            
            <div class="header-controls">

                <div class="more-menu-container">
                    <button id="more-menu-btn" class="icon-btn" onclick="toggleMoreMenu()" title="æ›´å¤šåŠŸèƒ½">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="19" cy="12" r="1"></circle>
                            <circle cx="5" cy="12" r="1"></circle>
                        </svg>
                    </button>

                    <div id="more-menu-dropdown" class="more-menu-dropdown">
                        
                        <button class="icon-btn" onclick="openQRModal()" title="TDAC QR Code">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <path d="M3 14h7v7H3z"></path>
                            </svg>
                            TDAC QR
                        </button>

                        <button id="reload-server-data-btn" class="icon-btn reload-server-btn" title="è®€å–ä¼ºæœå™¨è³‡æ–™">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M23 4v6h-6"></path>
                                <path d="M1 20v-6h6"></path>
                                <path d="M20.49 9A9 9 0 0 0 5.51 9"></path>
                                <path d="M3.51 15A9 9 0 0 0 18.49 15"></path>
                            </svg>
                            é‡ç½®è³‡æ–™
                        </button>
                        
                        <button id="theme-toggle-btn" class="icon-btn theme-toggle-btn" title="åˆ‡æ›æ·±è‰²/æ·ºè‰²ä¸»é¡Œ">
                            <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                            åˆ‡æ›ä¸»é¡Œ
                        </button>

                        <button id="copy-data-btn" class="icon-btn copy-btn" onclick="copyAppDataToClipboard()" title="è¤‡è£½æ‰€æœ‰æ•¸æ“š">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                            </svg>
                            è¤‡è£½æ•¸æ“š
                        </button>
                    </div>
                </div>
                
                <a href="https://www.google.com/maps/d/u/0/edit?mid=1pJlG73WanZkVkTSFvt3GLpMCDVU8heQ&ll=13.798196927110428%2C100.54907266665649&z=17" 
                   target="_blank" 
                   id="map-bookmark-btn" 
                   class="icon-btn map-bookmark-btn" 
                   title="æŸ¥çœ‹è¡Œç¨‹åœ°åœ–æ›¸ç±¤">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/>
                        <line x1="16" x2="16" y1="2" y2="22"/>
                        <line x1="8" x2="8" y1="2" y2="18"/>
                    </svg>
                </a>
                
                <button id="edit-toggle-btn" class="icon-btn edit-toggle-btn" onclick="toggleEditMode()" title="åˆ‡æ›ç·¨è¼¯æ¨¡å¼">
                    <svg id="edit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>
    
    <div id="toast-notification"></div>

    <nav class="day-nav">
        <div class="nav-container" id="nav-container">
            </div>
    </nav>

    <div id="swipe-container">
    <main id="schedule-container" class="schedule-container"></main>
</div>
    
    <div id="edit-modal" class="edit-modal">
        <div class="modal-content">
            <h3 id="modal-title">ç·¨è¼¯è¡Œç¨‹</h3>
            <form id="event-form">
                <input type="hidden" id="event-day-index">
                <input type="hidden" id="event-index">

                <div class="form-group">
                    <label for="event-time-input">æ™‚é–“ (æ ¼å¼: HH:MM æˆ– HH:MM-HH:MM)</label>
                    <input type="text" id="event-time-input" required>
                </div>

                <div class="form-group">
                    <label for="event-location-input">åœ°é»/æ´»å‹•</label>
                    <input type="text" id="event-location-input" required>
                </div>
                
                <div class="form-group">
                    <label for="event-map-url-input">åœ°åœ–é€£çµ (å¯é¸)</label>
                    <input type="url" id="event-map-url-input">
                </div>

                <div class="form-group">
                    <label for="event-note-url-input">å‚™è¨»é€£çµ (å¯é¸ï¼Œä¾‹å¦‚é è¨‚ç¶²å€)</label>
                    <input type="url" id="event-note-url-input">
                </div>

                <div class="form-group">
                    <label for="event-transport-input">äº¤é€šæ–¹å¼ (ä¾‹å¦‚: æ­¥è¡Œ, BTS, Bolt)</label>
                    <input type="text" id="event-transport-input" required>
                </div>

                <div class="form-group">
                    <label for="event-estimated-cost-input">é ä¼°èŠ±è²» (æ³°éŠ–)</label>
                    <input type="number" id="event-estimated-cost-input" value="0" min="0">
                </div>
                
                <div class="form-group">
                    <label for="event-notes-input">å‚™è¨» (å¯é¸)</label>
                    <textarea id="event-notes-input" rows="3"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button type="submit" class="save-btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="qr-modal" class="edit-modal"> <div class="modal-content qr-modal-content">
            <h3>TDAC QR Code</h3>
            
            <div class="qr-btn-group">
                <button class="qr-person-btn active" onclick="switchQR('æˆ‘', this)">æˆ‘</button>
                <button class="qr-person-btn" onclick="switchQR('åª½', this)">åª½</button>
                <button class="qr-person-btn" onclick="switchQR('å¦¹', this)">å¦¹</button>
            </div>

            <div class="qr-image-container">
                <img id="qr-image-display" src="tdac_æˆ‘.png" alt="TDAC QR Code" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2NjYyIgc3Ryb2tlLXdpZHRoPSIxIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxyZWN0IHg9IjMiIHk9IjMiIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgcng9IjIiIHJ5PSIyIi8+PHBhdGggZD0iTTEyIDh2OCIvPjxwYXRoIGQ9Ik04IDEybDggMCIvPjwvc3ZnPg==';this.title='åœ–ç‰‡æœªæ‰¾åˆ°'">
            </div>

            <div class="button-group" style="justify-content: center;">
                <button type="button" class="cancel-btn" onclick="closeQRModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        // --- å…¨å±€è®Šé‡å’Œæ•¸æ“šè™•ç† ---
        const STORAGE_KEY = 'bangkokTripData';
        const CHECK_KEY_SUFFIX = '_done';
        const COST_KEY_SUFFIX = '_cost';

        let appData = {};
        let currentDayIndex = 0;
        let isEditMode = false;

        // --- åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ---
        document.addEventListener('DOMContentLoaded', () => {
            appData = loadData();
            initApp();
            document.getElementById('event-form').addEventListener('submit', handleSaveEvent);
            
            // é»æ“Šé é¢å…¶ä»–åœ°æ–¹é—œé–‰æ›´å¤šé¸å–®
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('more-menu-dropdown');
                const btn = document.getElementById('more-menu-btn');
                if (!menu.contains(e.target) && !btn.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });
        });

        // --- æ•¸æ“šæŒä¹…åŒ– ---

        function loadData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    if (parsedData.days && parsedData.days.length > 0) {
                        return parsedData;
                    }
                } catch (e) {
                    console.error("Error parsing stored data, falling back to original data.", e);
                }
            }
            return originalTripData;
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }
        
        // --- è¤‡è£½æ•¸æ“šåŠŸèƒ½ (è¤‡è£½åˆ°å‰ªè²¼ç°¿) ---
        window.copyAppDataToClipboard = function() {
            // ç¢ºä¿ appData æ˜¯æœ€æ–°çš„
            const dataToCopy = JSON.stringify(appData, null, 4); 
            
            // ä½¿ç”¨ execCommand('copy') ä¾†è¤‡è£½åˆ°å‰ªè²¼ç°¿ (åœ¨ Canvas ç’°å¢ƒä¸­é€šå¸¸æ›´å¯é )
            const textarea = document.createElement('textarea');
            textarea.value = 'const originalTripData = ' + dataToCopy + ';';
            textarea.style.position = 'fixed'; // é˜²æ­¢æ»¾å‹•
            textarea.style.left = '-9999px'; // ç§»åˆ°è¢å¹•å¤–
            document.body.appendChild(textarea);
            
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('âœ… æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                } else {
                    showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
                }
            } catch (err) {
                console.error('Copy command failed:', err);
                showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
            }
            
            document.body.removeChild(textarea);
            
            // è¤‡è£½å®Œé †ä¾¿é—œé–‰é¸å–®
            document.getElementById('more-menu-dropdown').classList.remove('show');
        }
        
        // é¡¯ç¤º Toast é€šçŸ¥
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('visible');
            
            clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }


        // --- æ ¸å¿ƒæ‡‰ç”¨é‚è¼¯ ---

        function initApp() {
            determineInitialDay();
            renderNavigation();
            renderDay(currentDayIndex);
            updateEditButtonUI();
        }
        
        // 1. è‡ªå‹•åˆ¤æ–·ç•¶å‰æ—¥æœŸ
        function determineInitialDay() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            const foundIndex = appData.days.findIndex(d => d.fullDate === todayStr);
            
            if (foundIndex !== -1) {
                currentDayIndex = foundIndex;
            } else {
                currentDayIndex = 0; // é»˜èªç‚ºç¬¬ä¸€å¤©
            }
        }

        // 2. æ¸²æŸ“å°èˆªæ¬„
        function renderNavigation() {
        const navContainer = document.getElementById('nav-container');
        navContainer.innerHTML = '';

        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        appData.days.forEach((dayData, index) => {
            const btn = document.createElement('button');
            btn.className = `nav-btn ${index === currentDayIndex ? 'active' : ''}`;

            // å¾ fullDate (YYYY-MM-DD) å–å¾—æ˜ŸæœŸå¹¾
            const dateObj = new Date(dayData.fullDate);
            const month = dateObj.getMonth() + 1;
            const date = dateObj.getDate();
            const weekday = weekdays[dateObj.getDay()];

            btn.textContent = `${dayData.day} (${month}/${date} ${weekday})`;
            
            btn.onclick = () => {
                currentDayIndex = index;
                updateNavState();
                renderDay(index);
            };
            navContainer.appendChild(btn);
        });
        
        setTimeout(updateNavState, 100);
    }

        function updateNavState() {
            const btns = document.querySelectorAll('.nav-btn');
            btns.forEach((btn, index) => {
                if (index === currentDayIndex) {
                    btn.classList.add('active');
                    btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // æ–°å¢ï¼šæ‰‹æ©Ÿå·¦å³æ»‘å‹•åˆ‡æ›æ—¥æœŸ
    let touchStartX = 0;
    let touchEndX = 0;
    const minSwipeDistance = 50; // æœ€å°æ»‘å‹•è·é›¢æ‰è§¸ç™¼

    function handleTouchStart(e) {
        touchStartX = e.changedTouches[0].screenX;
    }

    function handleTouchEnd(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }

    function handleSwipe() {
        const swipeDistance = touchStartX - touchEndX;

        if (Math.abs(swipeDistance) < minSwipeDistance) return;

        if (swipeDistance > 0) {
            // å¾€å·¦æ»‘ â†’ ä¸‹ä¸€å¤©
            if (currentDayIndex < appData.days.length - 1) {
                currentDayIndex++;
            }
        } else {
            // å¾€å³æ»‘ â†’ å‰ä¸€å¤©
            if (currentDayIndex > 0) {
                currentDayIndex--;
            }
        }

        // æ›´æ–°ç•«é¢
        updateNavState();
        renderDay(currentDayIndex);

        window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
    }

    // æ”¹ç¶åˆ°å°ˆé–€çš„æ»‘å‹•å®¹å™¨ï¼Œå®Œç¾è§£æ±ºã€Œæ•´å€‹ç•«é¢è¢«æ‹–ã€çš„å•é¡Œ
const swipeContainer = document.getElementById('swipe-container');

swipeContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
swipeContainer.addEventListener('touchend', handleTouchEnd, { passive: true });

// å¯é¸ï¼šä¹Ÿæ”¯æ´æ»‘é¼ æ‹–æ›³æ¸¬è©¦ï¼ˆé›»è…¦ç”¨ï¼‰
swipeContainer.addEventListener('mousedown', (e) => mouseStartX = e.screenX);
swipeContainer.addEventListener('mouseup', (e) => {
    const diff = mouseStartX - e.screenX;
    if (Math.abs(diff) > 80) {
        if (diff > 0 && currentDayIndex < appData.days.length - 1) currentDayIndex++;
        else if (diff < 0 && currentDayIndex > 0) currentDayIndex--;
        updateNavState();
        renderDay(currentDayIndex);
    }
});

    // å¯é¸ï¼šä¹Ÿæ”¯æ´æ»‘é¼ æ‹–æ›³ï¼ˆåœ¨é›»è…¦ä¸Šæ¸¬è©¦ç”¨ï¼‰
    let mouseStartX = 0;
    document.body.addEventListener('mousedown', (e) => {
        mouseStartX = e.screenX;
    });
    document.body.addEventListener('mouseup', (e) => {
        const diff = mouseStartX - e.screenX;
        if (Math.abs(diff) > 80) {
            if (diff > 0 && currentDayIndex < appData.days.length - 1) {
                currentDayIndex++;
            } else if (diff < 0 && currentDayIndex > 0) {
                currentDayIndex--;
            }
            updateNavState();
            renderDay(currentDayIndex);
        }
    });

    // ... ä½ åŸæœ¬å‰©ä¸‹çš„æ‰€æœ‰ç¨‹å¼ç¢¼ç¹¼çºŒä¿æŒä¸è®Š ...

        // 3. æ¸²æŸ“ç•¶æ—¥è¡Œç¨‹
        function renderDay(dayIndex) {
            const container = document.getElementById('schedule-container');
            const dayData = appData.days[dayIndex];
            
            container.innerHTML = '';

            const themeHeader = document.createElement('div');
            themeHeader.style.textAlign = 'center';
            themeHeader.innerHTML = `<h2 class="day-theme">${dayData.theme}</h2>`;
            container.appendChild(themeHeader);

            const timeline = document.createElement('div');
            timeline.className = 'timeline';

            let dailyTotal = 0;

            dayData.events.forEach((event, eventIndex) => {
                const storageKeyPrefix = `trip_d${dayIndex}_e${eventIndex}`;
                const isCompleted = localStorage.getItem(`${storageKeyPrefix}${CHECK_KEY_SUFFIX}`) === 'true';
                const storedCost = localStorage.getItem(`${storageKeyPrefix}${COST_KEY_SUFFIX}`);
                
                const displayCost = storedCost !== null ? storedCost : '';
                // æª¢æŸ¥ storedCost æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—ï¼Œä»¥ç´¯åŠ åˆ° dailyTotal
                if (storedCost && !isNaN(parseInt(storedCost))) dailyTotal += parseInt(storedCost);

                const card = document.createElement('div');
                card.className = `event-card ${isCompleted ? 'completed' : ''}`;
                card.id = `card-${dayIndex}-${eventIndex}`;

                let transportIcon = 'ğŸš¶';
                let transportClass = 'trans-walk';
                const t = event.transport ? event.transport.toLowerCase() : '';
                
                if (t.includes('bts') || t.includes('mrt')) {
                    transportIcon = 'ğŸš†';
                    transportClass = 'trans-bts';
                } else if (t.includes('èˆ¹') || t.includes('æ¸¡è¼ª') || t.includes('ferry')) {
                    transportIcon = 'â›´ï¸';
                    transportClass = 'trans-boat';
                } else if (t.includes('bolt') || t.includes('åŒ…è»Š') || t.includes('å…¬è»Š') || t.includes('car')) {
                    transportIcon = 'ğŸš—';
                    transportClass = 'trans-car';
                }
                else if (t.includes('é£›æ©Ÿ')) {
                    transportIcon = 'âœˆï¸';
                    transportClass = 'trans-bts';
                }

                const formattedNotes = formatNotes(event.notes);
                
                let headerContent = '';
                if (isEditMode) {
                    headerContent = `
                        <div class="edit-controls">
                            <button onclick="startEditEvent(${dayIndex}, ${eventIndex})" class="edit-icon" title="ç·¨è¼¯è¡Œç¨‹">
                                âœï¸
                            </button>
                            <button onclick="deleteEvent(${dayIndex}, ${eventIndex})" class="delete-icon" title="åˆªé™¤è¡Œç¨‹">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    `;
                } 
                // else {
                //      headerContent = `
                //          <label class="checkbox-wrapper">
                //              <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                //                  onchange="toggleComplete(${dayIndex}, ${eventIndex}, this)">
                //          </label>
                //      `;
                // }

                // åœ°åœ–åœ–æ¨™å’Œé€£çµ
                const mapIconHTML = event.mapURL ? `
                    <a href="${event.mapURL}" target="_blank" class="map-icon" title="æŸ¥çœ‹åœ°åœ–">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                    </a>
                ` : '';

                // å‚™è¨»é€£çµåœ–æ¨™å’Œé€£çµ
                const noteIconHTML = event.noteURL ? `
                    <a href="${event.noteURL}" target="_blank" class="note-icon" title="æŸ¥çœ‹å‚™è¨»é€£çµ">
                        ğŸš€
                    </a>
                ` : '';

                // å‚™è¨»æ”¶æŠ˜åŠŸèƒ½çµæ§‹
                const notesHTML = event.notes ? `
                    <div class="notes-container" id="notes-container-${dayIndex}-${eventIndex}">
                        <div class="event-notes collapsed" id="event-notes-${dayIndex}-${eventIndex}">
                            ${formattedNotes}
                        </div>
                        <button class="toggle-notes-btn" onclick="toggleNotes(${dayIndex}, ${eventIndex}, this)">
                            å±•é–‹å‚™è¨» ğŸ”½
                        </button>
                    </div>
                ` : '';
                
                card.innerHTML = `
                    <div class="event-header">
                        <span class="event-time">${event.time}</span>
                        ${headerContent}
                    </div>
                    
                    <div class="event-location-group">
                        <div class="event-location">${event.location}</div>
                        ${mapIconHTML}
                        ${noteIconHTML}
                    </div>
                    
                    <div class="event-details">
                        <span class="badge ${transportClass}">${transportIcon} ${event.transport}</span>
                        <div class="cost-section" onclick="enableCostEdit(${dayIndex}, ${eventIndex}, this)">
                            <span id="cost-display-${dayIndex}-${eventIndex}">
                                ${storedCost ? `å¯¦æ”¯: à¸¿${storedCost}` : `é ä¼°: à¸¿${event.cost}`}
                            </span>
                        </div>
                    </div>
                    
${notesHTML}
                `;

                timeline.appendChild(card);
            });

            container.appendChild(timeline);
            
            // ç·¨è¼¯æ¨¡å¼ä¸‹é¡¯ç¤ºæ–°å¢æŒ‰éˆ•
            if (isEditMode) {
                const addBtn = document.createElement('button');
                addBtn.className = 'add-event-btn';
                addBtn.textContent = '+ æ–°å¢è¡Œç¨‹';
                addBtn.onclick = () => startAddEvent(dayIndex);
                container.appendChild(addBtn);
            }

            // æ¯æ—¥ç¸½çµ
            const summary = document.createElement('div');
            summary.className = 'daily-summary';
            summary.innerHTML = `
                <div class="total-label">æœ¬æ—¥å¯¦éš›ç¸½èŠ±è²»</div>
                <div class="total-amount">à¸¿${dailyTotal}</div>
                <button class="reset-btn" onclick="resetDailyCosts(${dayIndex})">é‡ç½®æœ¬æ—¥èŠ±è²»</button>
            `;
            container.appendChild(summary);
        }

        // --- ç·¨è¼¯æ¨¡å¼åŠŸèƒ½ & æ’åº ---
        
        // è¼”åŠ©å‡½æ•¸ï¼šå–å¾—ç”¨æ–¼æ’åºçš„æ™‚é–“ï¼ˆå–æ™‚é–“ç¯„åœçš„èµ·å§‹æ™‚é–“ï¼‰
        function getSortableTime(timeStr) {
            // ç¢ºä¿ timeStr å­˜åœ¨ä¸”æ˜¯å­—ä¸²
            if (!timeStr || typeof timeStr !== 'string') return '99:99'; 
            
            // å¦‚æœæ˜¯æ™‚é–“ç¯„åœ (ä¾‹å¦‚ "09:00-10:00")ï¼Œåªå–èµ·å§‹æ™‚é–“ ("09:00")
            const parts = timeStr.split('-');
            return parts[0].trim();
        }

        // æ ¸å¿ƒæ’åºå‡½æ•¸ï¼šä¾æ™‚é–“æ’åºè¡Œç¨‹
        function sortEventsByTime(events) {
            events.sort((a, b) => {
                const timeA = getSortableTime(a.time);
                const timeB = getSortableTime(b.time);

                // æ¨™æº–å­—ä¸²æ¯”è¼ƒå° HH:MM æ ¼å¼æœ‰æ•ˆ
                if (timeA < timeB) {
                    return -1;
                }
                if (timeA > timeB) {
                    return 1;
                }
                // æ™‚é–“ç›¸åŒæ™‚ä¸æ”¹è®Šé †åº
                return 0;
            });
        }

        window.toggleEditMode = function() {
            isEditMode = !isEditMode;
            updateEditButtonUI();
            renderDay(currentDayIndex);
        }

        function updateEditButtonUI() {
            const btn = document.getElementById('edit-toggle-btn');
            const iconElement = document.getElementById('edit-icon');

            if (isEditMode) {
                btn.classList.add('active');
                btn.title = 'çµæŸç·¨è¼¯æ¨¡å¼';
                // åˆ‡æ›ç‚º Save/Check åœ–æ¨™ (è¡¨ç¤ºé€²å…¥ç·¨è¼¯/ä¿å­˜ç‹€æ…‹)
                iconElement.innerHTML = `<path d="M5 12l5 5l8-8"/>`; 
            } else {
                btn.classList.remove('active');
                btn.title = 'åˆ‡æ›ç·¨è¼¯æ¨¡å¼';
                // åˆ‡æ›å› Pencil åœ–æ¨™
                iconElement.innerHTML = `<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>`;
            }
        }
        
        // æ‰“é–‹ç·¨è¼¯/æ–°å¢ Modal
        function openEditModal(dayIndex, eventIndex, isNew = false) {
            const modal = document.getElementById('edit-modal');
            const form = document.getElementById('event-form');
            const title = document.getElementById('modal-title');
            
            // é‡è¨­è¡¨å–®
            form.reset();
            
            document.getElementById('event-day-index').value = dayIndex;
            document.getElementById('event-index').value = eventIndex !== null ? eventIndex : -1;

            if (isNew) {
                title.textContent = 'æ–°å¢è¡Œç¨‹';
                document.getElementById('event-estimated-cost-input').value = '0'; // é è¨­æˆæœ¬ç‚º 0
            } else {
                title.textContent = 'ç·¨è¼¯è¡Œç¨‹';
                const event = appData.days[dayIndex].events[eventIndex];
                document.getElementById('event-time-input').value = event.time;
                document.getElementById('event-location-input').value = event.location;
                document.getElementById('event-map-url-input').value = event.mapURL || '';
                document.getElementById('event-note-url-input').value = event.noteURL || '';
                document.getElementById('event-transport-input').value = event.transport;
                document.getElementById('event-estimated-cost-input').value = event.cost;
                document.getElementById('event-notes-input').value = event.notes;
            }

            modal.classList.add('visible');
        }

        window.closeEditModal = function() {
            document.getElementById('edit-modal').classList.remove('visible');
        }
        
        window.startEditEvent = function(dayIndex, eventIndex) {
            openEditModal(dayIndex, eventIndex, false);
        }

        window.startAddEvent = function(dayIndex) {
            openEditModal(dayIndex, null, true);
        }

        // å„²å­˜äº‹ä»¶è™•ç† (åŒ…å«æ’åºé‚è¼¯)
        function handleSaveEvent(e) {
            e.preventDefault();
            
            const dayIndex = parseInt(document.getElementById('event-day-index').value);
            const eventIndex = parseInt(document.getElementById('event-index').value);

            const newEvent = {
                time: document.getElementById('event-time-input').value,
                location: document.getElementById('event-location-input').value,
                mapURL: document.getElementById('event-map-url-input').value.trim(),
                noteURL: document.getElementById('event-note-url-input').value.trim(),
                transport: document.getElementById('event-transport-input').value,
                cost: document.getElementById('event-estimated-cost-input').value || '0',
                notes: document.getElementById('event-notes-input').value
            };

            if (eventIndex === -1) {
                // æ–°å¢
                appData.days[dayIndex].events.push(newEvent);
            } else {
                // ä¿®æ”¹
                appData.days[dayIndex].events[eventIndex] = newEvent;
            }

            // æ’åºç•¶æ—¥æ‰€æœ‰è¡Œç¨‹
            sortEventsByTime(appData.days[dayIndex].events);

            saveData();
            closeEditModal();
            renderDay(dayIndex);
        }

        // åˆªé™¤äº‹ä»¶è™•ç†
        window.deleteEvent = function(dayIndex, eventIndex) {
            // NOTE: ä½¿ç”¨ç€è¦½å™¨å…§å»ºçš„ confirm() åœ¨ iFrame ç’°å¢ƒä¸­å¯èƒ½ä¸å¯è¦‹ï¼Œä½†æ­¤è™•ä½œç‚ºç¯„ä¾‹æš«æ™‚ä¿ç•™ã€‚
            // å»ºè­°åœ¨å¯¦éš›æ‡‰ç”¨ä¸­æ›¿æ›ç‚ºè‡ªå®šç¾© Modalã€‚
            if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ")) return;

            // ç§»é™¤è¡Œç¨‹
            appData.days[dayIndex].events.splice(eventIndex, 1);
            saveData();
            
            // åˆªé™¤ç›¸é—œçš„ LocalStorage æ•¸æ“š
            localStorage.removeItem(`trip_d${dayIndex}_e${eventIndex}${CHECK_KEY_SUFFIX}`);
            localStorage.removeItem(`trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`);
            
            // é‡æ–°æ’åºä¸¦æ¸²æŸ“
            sortEventsByTime(appData.days[dayIndex].events);
            renderDay(dayIndex);
        }

        // --- è¨˜å¸³åŠŸèƒ½ (ä¿ç•™åŸæœ‰åŠŸèƒ½) ---

        function formatNotes(text) {
    if (!text) return "";

    // 1. å°‡è¼¸å…¥æ–‡æœ¬æŒ‰è¡Œåˆ†å‰²ä¸¦éæ¿¾ç©ºè¡Œ
    const lines = text.trim().split('\n').map(line => line.trim()).filter(line => line.length > 0);

    let html = '<ul>'; // ä½¿ç”¨ç„¡åºåˆ—è¡¨ä¾†åŒ…è£¹æ‰€æœ‰å…§å®¹

    // ç¨ç«‹å‡ºä¾†çš„å‡½æ•¸ï¼Œç”¨æ–¼åŸ·è¡Œé«˜äº®é‚è¼¯
    const applyHighlighting = (item) => {
        let itemHtml = item;

        // 1. å° ( ) å…§å®¹åšé«˜äº®
        // æ‰¾åˆ°æ‰€æœ‰è¢«æ‹¬è™ŸåŒ…è£¹çš„å…§å®¹ï¼Œä¸¦ç”¨ <span class="highlight-parentheses"> åŒ…è£¹
        itemHtml = itemHtml.replace(/(\([^)]+\))/g, (match) => {
            // ä½¿ç”¨ highlight-parentheses class
            return `<span class="highlight-parentheses">${match}</span>`;
        });

        // 2. å°æ•¸å­—ã€åƒ¹æ ¼ã€ç™¾åˆ†æ¯”åšé«˜äº® (ä¾‹å¦‚: 100, 50%, 3å€‹)
        // ä½¿ç”¨ price-info class
        itemHtml = itemHtml.replace(/(\b\d+[\s%å€‹]*)/g, (match) => {
            return `<span class="price-info">${match}</span>`;
        });

        return itemHtml;
    };


    lines.forEach(line => {
        // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ indexOf æ‰¾ç¬¬ä¸€å€‹ '-' ç¬¦è™Ÿ
        const separatorIndex = line.indexOf('-');

        // åˆ¤æ–·æ˜¯å¦æœ‰ `-` ä¸” `-` å¾Œé¢æœ‰å…§å®¹ (æˆ–å‰é¢å…§å®¹ä¸æ˜¯ç´”ç©º)
        if (separatorIndex !== -1 && (separatorIndex > 0 || separatorIndex < line.length - 1)) {
            // åŒ¹é…æˆåŠŸï¼šé€™æ˜¯ä¸€è¡Œ "Title - Content" çµæ§‹çš„å…§å®¹

            const floorTitle = applyHighlighting(line.substring(0, separatorIndex).trim());
            const content = line.substring(separatorIndex + 1).trim();

            // é–‹å§‹æ–°çš„åˆ—è¡¨é …ï¼Œä¸¦ä½¿ç”¨ <h3> ä½œç‚ºæ¨“å±¤æ¨™é¡Œ
            html += `
                <li class="floor-section">
                    <h3 class="floor-title">âœ¨ ${floorTitle}</h3>
                    <ul class="floor-content-list">
            `;

            // å°‡å…§å®¹æŒ‰é “è™Ÿ/é€—è™Ÿåˆ†å‰²æˆå­é …ç›® (ç¢ºä¿åˆ†éš”ç¬¦è™Ÿä¸åœ¨æ‹¬è™Ÿå…§)
            const contentItems = content.split(/\s*(?:ã€|,)\s*(?![^(]*\))/).map(item => item.trim()).filter(item => item.length > 0);

            contentItems.forEach(item => {
                // å°åˆ†å‰²å¾Œçš„å­é …ç›®å¥—ç”¨é«˜äº®
                const itemHtml = applyHighlighting(item);
                html += `<li>${itemHtml}</li>`;
            });

            html += `</ul></li>`;

        } else if (line.length > 0) {
            // åŒ¹é…å¤±æ•—ï¼šé€™æ˜¯ä¸€è¡Œç¨ç«‹çš„å…§å®¹
            
            const lineHtml = applyHighlighting(line);

            html += `<li class="floor-section"><h3>âœ¨${lineHtml}</h3></li>`;
        }
    });

    // ç¢ºä¿æœ€å¾Œçš„ <ul> æ¨™ç±¤è¢«é—œé–‰
    html += '</ul>';

    return html;
}

        // åˆ‡æ›å®Œæˆç‹€æ…‹
        window.toggleComplete = function(dayIndex, eventIndex, checkbox) {
            if (isEditMode) return; // ç·¨è¼¯æ¨¡å¼ä¸‹ç¦ç”¨æ‰“å‹¾
            const card = document.getElementById(`card-${dayIndex}-${eventIndex}`);
            const key = `trip_d${dayIndex}_e${eventIndex}${CHECK_KEY_SUFFIX}`;
            
            if (checkbox.checked) {
                localStorage.setItem(key, 'true');
                card.classList.add('completed');
            } else {
                localStorage.removeItem(key);
                card.classList.remove('completed');
            }
        };

        // å•Ÿç”¨è²»ç”¨ç·¨è¼¯
        window.enableCostEdit = function(dayIndex, eventIndex, element) {
            if (isEditMode) return; // ç·¨è¼¯æ¨¡å¼ä¸‹ç¦ç”¨è¨˜å¸³ç·¨è¼¯
            if (element.querySelector('input')) return;

            const displaySpan = document.getElementById(`cost-display-${dayIndex}-${eventIndex}`);
            const savedCost = localStorage.getItem(`trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`);
            const initialValue = savedCost ? savedCost : '';

            element.innerHTML = `
                <input type="number" class="cost-input" value="${initialValue}" 
                placeholder="é‡‘é¡" 
                onblur="saveCost(${dayIndex}, ${eventIndex}, this)" 
                onkeydown="if(event.key === 'Enter') this.blur()">
            `;
            
            const input = element.querySelector('input');
            input.focus();
        };

        // å„²å­˜è²»ç”¨ä¸¦é‡ç¹ª
        window.saveCost = function(dayIndex, eventIndex, input) {
            const val = input.value;
            const key = `trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`;

            if (val && val.trim() !== "" && parseInt(val) >= 0) {
                localStorage.setItem(key, val);
            } else {
                localStorage.removeItem(key);
            }

            renderDay(dayIndex);
        };

        // é‡ç½®ç•¶æ—¥èŠ±è²»
        window.resetDailyCosts = function(dayIndex) {
            // NOTE: ä½¿ç”¨ç€è¦½å™¨å…§å»ºçš„ confirm() åœ¨ iFrame ç’°å¢ƒä¸­å¯èƒ½ä¸å¯è¦‹ï¼Œä½†æ­¤è™•ä½œç‚ºç¯„ä¾‹æš«æ™‚ä¿ç•™ã€‚
            // å»ºè­°åœ¨å¯¦éš›æ‡‰ç”¨ä¸­æ›¿æ›ç‚ºè‡ªå®šç¾© Modalã€‚
            if(!confirm("ç¢ºå®šè¦é‡ç½®ä»Šå¤©çš„è¨˜å¸³æ•¸æ“šå—ï¼Ÿ")) return;
            
            const dayData = appData.days[dayIndex];
            dayData.events.forEach((_, eIndex) => {
                localStorage.removeItem(`trip_d${dayIndex}_e${eIndex}${COST_KEY_SUFFIX}`);
            });
            renderDay(dayIndex);
        };
        
        // --- ä¸‹æ‹‰é¸å–®åŠŸèƒ½ ---
        window.toggleMoreMenu = function() {
            const dropdown = document.getElementById('more-menu-dropdown');
            dropdown.classList.toggle('show');
        }

        // --- QR Code åŠŸèƒ½ ---
        window.openQRModal = function() {
            // é—œé–‰ä¸‹æ‹‰é¸å–®
            document.getElementById('more-menu-dropdown').classList.remove('show');
            // é–‹å•Ÿ QR modal
            document.getElementById('qr-modal').classList.add('visible');
            
            // é è¨­é¸ä¸­ 'æˆ‘'
            const btns = document.querySelectorAll('.qr-person-btn');
            btns.forEach(b => b.textContent === 'æˆ‘' ? b.click() : null);
        }

        window.closeQRModal = function() {
            document.getElementById('qr-modal').classList.remove('visible');
        }

        window.switchQR = function(person, btn) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.qr-person-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // æ›´æ–°åœ–ç‰‡
            const img = document.getElementById('qr-image-display');
            img.src = `tdac_${person}.png`;
        }
        // --- QR Code åŠŸèƒ½çµæŸ ---

        // ä¸»é¡Œåˆ‡æ›ï¼ˆé è¨­æ·±è‰²ï¼‰
        // æ³¨æ„ï¼šé€™è£¡çš„äº‹ä»¶ç›£è½è¦ç§»åˆ° load æˆ– onclick è£¡ï¼Œå› ç‚º DOM é‡ç¹ªäº†
        // ä¸‹é¢é€™æ®µæˆ‘æ•´åˆé€²äº†ä¸Šé¢çš„ more-menu é»æ“Šäº‹ä»¶ï¼Œé€™è£¡ä¿ç•™åˆå§‹åŒ–é‚è¼¯
    const themeIcon = document.getElementById('theme-icon');
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
    
    // ç¶å®šæ–°çš„ä¸»é¡Œåˆ‡æ›æŒ‰éˆ•äº‹ä»¶ (å› ç‚ºæŒ‰éˆ•ç§»å‹•ä½ç½®äº†)
    document.getElementById('theme-toggle-btn').addEventListener('click', () => {
        const current = document.body.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
        
        // åˆ‡æ›å¾Œé—œé–‰é¸å–®
        document.getElementById('more-menu-dropdown').classList.remove('show');
    });

    function updateThemeIcon(theme) {
        if (theme === 'dark') {
            // æœˆäº® = æ·±è‰²
            themeIcon.innerHTML = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`;
        } else {
            // å¤ªé™½ = æ·ºè‰²
            themeIcon.innerHTML = `
                <circle cx="12" cy="12" r="5"/>
                <line x1="12" y1="1" x2="12" y2="3"/>
                <line x1="12" y1="21" x2="12" y2="23"/>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                <line x1="1" y1="12" x2="3" y2="12"/>
                <line x1="21" y1="12" x2="23" y2="12"/>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            `;
        }
    }

        // === æ—¥æœŸå°èˆªæ¬„ æ»¾å‹•å‘ä¸Šè‡ªå‹•éš±è—ï¼ˆè¶…é †æ»‘ï¼‰===
    let lastScrollY = window.scrollY;
    const dayNav = document.querySelector('.day-nav');

    window.addEventListener('scroll', () => {
        const currentScrollY = window.scrollY;
        
        if (currentScrollY > lastScrollY && currentScrollY > 150) {
            // å¾€ä¸‹æ»¾ â†’ éš±è—å°èˆªæ¬„
            dayNav.classList.remove('show');
            dayNav.classList.add('hide');
        } else if (currentScrollY < lastScrollY) {
            // å¾€ä¸Šæ»¾ â†’ é¡¯ç¤ºå°èˆªæ¬„
            dayNav.classList.remove('hide');
            dayNav.classList.add('show');
        }
        
        lastScrollY = currentScrollY;
    });

        // === é»æ“Šæ—¥æœŸå°èˆªæ¬„ â†’ å¹³æ»‘æ»¾å‹•åˆ°é é¢é ‚éƒ¨ ===
    document.querySelector('.day-nav').addEventListener('click', (e) => {
        // åªåœ¨é»æ“Šåˆ° .day-nav æœ¬èº«çš„ç©ºç™½è™•æ‰è§¸ç™¼ï¼ˆé¿å…é»æŒ‰éˆ•æ™‚ä¹Ÿè·³é ‚ï¼‰
        if (e.target === document.querySelector('.day-nav') || 
            e.target.closest('.nav-container')) {
            
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    });

        // --- å‚™è¨»æ”¶æŠ˜åŠŸèƒ½é‚è¼¯ (æ–°å¢) ---
        window.toggleNotes = function(dayIndex, eventIndex, button) {
            const notesElement = document.getElementById(`event-notes-${dayIndex}-${eventIndex}`);
            
            if (notesElement.classList.contains('collapsed')) {
                // å±•é–‹
                notesElement.classList.remove('collapsed');
                button.textContent = 'æ”¶èµ·å‚™è¨» ğŸ”¼';
                // èª¿æ•´é«˜åº¦ä»¥ç¢ºä¿å…§å®¹å®Œå…¨é¡¯ç¤º
                notesElement.style.maxHeight = notesElement.scrollHeight + "px";
            } else {
                // æ”¶æŠ˜
                notesElement.classList.add('collapsed');
                button.textContent = 'å±•é–‹å‚™è¨» ğŸ”½';
                // ä½¿ç”¨ CSS è¨­å®šçš„æ”¶æŠ˜é«˜åº¦
                notesElement.style.maxHeight = '100px'; 
            }
        }
        // --- å‚™è¨»æ”¶æŠ˜åŠŸèƒ½é‚è¼¯ (çµæŸ) ---

        // ===== é‡æ–°å¾ä¼ºæœå™¨è¼‰å…¥åŸå§‹è³‡æ–™ =====
    document.getElementById('reload-server-data-btn')?.addEventListener('click', () => {
        const userConfirmed = confirm(
            "âš ï¸ é€™æœƒæŠŠä½ ç›®å‰åœ¨ localStorage è£¡çš„æ‰€æœ‰è‡ªè¨‚è¡Œç¨‹ã€è¨˜å¸³ã€å®Œæˆç‹€æ…‹å…¨éƒ¨è¦†è“‹ï¼Œæ¢å¾©æˆæœ€ä¸€é–‹å§‹çš„åŸå§‹è¡Œç¨‹ï¼\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ"
        );

        if (!userConfirmed) return;

        // 1. ç”¨åŸå§‹è³‡æ–™è¦†è“‹ç›®å‰è¨˜æ†¶é«”ä¸­çš„ appData
        appData = JSON.parse(JSON.stringify(originalTripData));   // æ·±æ‹·è²ï¼Œé¿å…ä¹‹å¾Œæ”¹åˆ°åŸå§‹è³‡æ–™

        // 2. æ¸…ç©ºæ‰€æœ‰ç›¸é—œçš„ localStorageï¼ˆè¡Œç¨‹ã€æ‰“å‹¾ã€è¨˜å¸³â€¦ï¼‰
        localStorage.removeItem(STORAGE_KEY);

        // æ¸…é™¤æ‰€æœ‰ã€Œå®Œæˆã€èˆ‡ã€Œå¯¦æ”¯ã€çš„ keyï¼ˆä»¥ trip_ é–‹é ­çš„ï¼‰
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (key.startsWith('trip_') || key.startsWith('bangkokTripData'))) {
                localStorage.removeItem(key);
            }
        }

        // 3. é‡æ–°å¯«å…¥ä¹¾æ·¨çš„åŸå§‹è³‡æ–™
        saveData();   // æœƒæŠŠæ–°çš„ appData å­˜é€² localStorage

        // 4. æç¤ºæˆåŠŸ + é‡æ–°æ•´ç†ç•«é¢
        showToast('âœ… å·²æˆåŠŸå¾ä¼ºæœå™¨é‡æ–°è¼‰å…¥åŸå§‹è¡Œç¨‹ï¼');
        setTimeout(() => location.reload(), 1200);   // ç¨å¾®å»¶é²è®“ toast èƒ½çœ‹åˆ°
    });
    </script>
</body>
</html>
